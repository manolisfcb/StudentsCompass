{% extends "base.html" %}
{% set page_title = "Communities" %}
{% set page_description = "Discover student communities, join groups, and connect with peers to grow your career network and share progress inside Student Compass." %}
{% block head_extra %}
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .communities-container { padding: 2rem; }

    @media (max-width: 768px) {
      .communities-container { padding: 1rem; }
    }

    .communities-header { margin-bottom: 1.5rem; }
    .communities-header h2 { font-size: 2rem; color: #0F172A; margin-bottom: 0.3rem; }
    .communities-header p  { color: #475569; font-size: 1.05rem; }

    @media (max-width: 768px) {
      .communities-header h2 { font-size: 1.5rem; }
      .communities-header p { font-size: 0.95rem; }
    }

    .communities-header-row {
      display: flex; align-items: center;
      justify-content: space-between;
      gap: 1rem; flex-wrap: wrap;
    }

    /* â”€â”€ Search & filter bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .filter-bar {
      display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem;
    }
    .filter-bar input,
    .filter-bar select {
      padding: 0.6rem 0.9rem;
      border: 1px solid #E2E8F0; border-radius: 10px;
      font-size: 0.9rem; background: #F8FAFC; color: #0F172A;
      transition: border-color .2s, box-shadow .2s;
      box-sizing: border-box;
    }
    .filter-bar input:focus,
    .filter-bar select:focus {
      border-color: #0F766E;
      box-shadow: 0 0 0 3px rgba(15,118,110,.15);
      outline: none;
    }
    .filter-bar input { flex: 1; min-width: 180px; }

    @media (max-width: 768px) {
      .filter-bar {
        flex-direction: column;
        gap: 0.5rem;
      }
      .filter-bar input,
      .filter-bar select {
        width: 100%;
      }
    }

    /* â”€â”€ Grid de cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .communities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
      align-items: stretch;
    }

    .community-card {
      background: white; border-radius: 12px; padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
      border: 1px solid #E2E8F0;
      display: flex; flex-direction: column; gap: 0.75rem;
      transition: transform .25s ease, box-shadow .25s ease;
      cursor: pointer;
    }
    .community-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,.1);
    }

    .community-icon {
      width: 56px; height: 56px;
      background: linear-gradient(135deg, #0F766E 0%, #5EEAD4 100%);
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.8rem; flex-shrink: 0;
    }

    .community-title { font-size: 1.2rem; font-weight: 600; color: #0F172A; }

    .community-description {
      color: #475569; font-size: 0.92rem; line-height: 1.5;
      display: -webkit-box; -webkit-line-clamp: 2;
      -webkit-box-orient: vertical; overflow: hidden;
      min-height: calc(2 * 1.5 * .92rem);
    }

    .community-stats { display: flex; gap: 1rem; flex-wrap: wrap; }
    .stat-item {
      display: flex; align-items: center; gap: 0.3rem;
      font-size: 0.85rem; color: #475569;
    }
    .stat-item svg { width: 16px; height: 16px; }

    .community-tags {
      display: flex; flex-wrap: wrap; gap: 0.4rem;
      min-height: 1.6rem; max-height: 3.8rem; overflow: hidden;
    }
    .tag {
      background: #E5E7EB; color: #0F766E;
      padding: 0.25rem 0.7rem; border-radius: 20px;
      font-size: 0.78rem; font-weight: 600;
    }

    .join-btn {
      width: 100%; padding: 0.7rem;
      background: linear-gradient(135deg, #0F766E 0%, #5EEAD4 100%);
      color: white; border: none; border-radius: 8px;
      font-weight: 600; cursor: pointer;
      transition: opacity .2s;
      margin-top: auto; flex-shrink: 0;
    }
    .join-btn:hover { opacity: .9; }
    .join-btn.joined {
      background: #E0F2F1; color: #0F766E;
      cursor: default;
    }

    .community-status {
      font-size: .72rem; padding: .2rem .55rem;
      border-radius: 999px; background: #E0F2F1;
      color: #0F766E; font-weight: 600;
    }

    /* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
      text-align: center; color: #64748B; padding: 3rem 1rem;
    }
    .empty-state svg { width: 64px; height: 64px; margin-bottom: 1rem; color: #CBD5E1; }

    /* â”€â”€ Create button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .create-community-btn {
      padding: .7rem 1.2rem;
      background: linear-gradient(135deg, #0F766E 0%, #5EEAD4 100%);
      color: white; border: none; border-radius: 10px;
      font-weight: 600; cursor: pointer;
      transition: opacity .2s;
      white-space: nowrap;
    }
    .create-community-btn:hover { opacity: .9; }

    /* â”€â”€ Modal (create community) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body.modal-open { overflow: hidden; }

    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(15,23,42,.6);
      display: none; align-items: center; justify-content: center;
      padding: 1.5rem; z-index: 50;
    }

    .modal *, .modal *::before, .modal *::after { box-sizing: border-box; }

    .modal {
      background: white; border-radius: 16px;
      padding: 0; width: 100%; max-width: 520px; max-height: 90vh;
      display: flex; flex-direction: column; overflow: hidden;
      box-shadow: 0 10px 30px rgba(15,23,42,.2);
    }

    .modal__header {
      position: sticky; top: 0; background: white; z-index: 2;
      display: flex; align-items: center; justify-content: space-between;
      padding: 1rem 1.25rem; border-bottom: 1px solid #E2E8F0;
    }
    .modal__title { margin: 0; font-size: 1.25rem; color: #0F172A; }
    .modal__close {
      border: none; background: transparent;
      font-size: 1.4rem; cursor: pointer; color: #475569;
    }

    .modal__body {
      padding: 1rem 1.25rem 1.25rem;
      flex: 1 1 auto; min-height: 0;
      overflow-y: auto; overflow-x: hidden;
    }

    .modal__footer {
      padding: 1rem 1.25rem;
      border-top: 1px solid #E2E8F0;
      background: white; flex-shrink: 0;
    }
    .modal__footer .primary-btn { width: 100%; }

    .community-form { display: grid; gap: .75rem; }

    .form__group { display: flex; flex-direction: column; gap: .4rem; }
    .form__label { font-size: .9rem; font-weight: 600; color: #0F172A; }

    .form__field {
      display: block; width: 100%; max-width: 100%;
      border: 1px solid #E2E8F0; border-radius: 12px;
      padding: .75rem .9rem; font-size: .95rem;
      background: #F8FAFC; color: #0F172A;
      transition: border-color .2s, box-shadow .2s;
    }
    .form__field:focus {
      border-color: #0F766E;
      box-shadow: 0 0 0 3px rgba(15,118,110,.15);
      outline: none;
    }

    .primary-btn {
      padding: .7rem 1rem;
      background: linear-gradient(135deg, #0F766E 0%, #5EEAD4 100%);
      color: white; border: none; border-radius: 8px;
      font-weight: 600; cursor: pointer;
    }

    /* â”€â”€ Icon Input Group â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .icon-input { display: flex; flex-direction: column; gap: .5rem; }
    .icon-input__group {
      display: flex; align-items: stretch;
      border: 1px solid #E2E8F0; border-radius: 12px;
      background: #F8FAFC; overflow: hidden;
      transition: border-color .2s, box-shadow .2s;
    }
    .icon-input__group:focus-within {
      border-color: #0F766E;
      box-shadow: 0 0 0 3px rgba(15,118,110,.15);
    }
    .icon-input__preview {
      width: 44px; flex-shrink: 0;
      display: grid; place-items: center; font-size: 1.25rem;
      background: #F1F5F9; border-right: 1px solid #E2E8F0;
    }
    .icon-input__field {
      flex: 1; min-width: 0; border: none; background: transparent;
      padding: .75rem .8rem; font-size: .95rem; color: #0F172A; outline: none;
    }
    .icon-input__field::placeholder { color: #94A3B8; }
    .icon-input__button {
      flex-shrink: 0; padding: 0 1rem; border: none;
      border-left: 1px solid #E2E8F0; background: white;
      color: #0F766E; font-weight: 600; font-size: .875rem;
      cursor: pointer; white-space: nowrap;
      transition: background .15s;
    }
    .icon-input__button:hover { background: #F0FDFA; }
    .icon-input__button:focus-visible { outline: 2px solid #0F766E; outline-offset: -2px; }

    /* â”€â”€ Emoji picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .emoji-picker {
      display: none; border: 1px solid #E2E8F0; border-radius: 12px;
      background: white; box-shadow: 0 10px 30px rgba(15,23,42,.15); overflow: hidden;
    }
    .emoji-picker__header {
      display: flex; align-items: center; gap: .5rem;
      padding: .6rem; border-bottom: 1px solid #E2E8F0;
    }
    .emoji-picker__search {
      flex: 1; border: 1px solid #E2E8F0; border-radius: 10px; padding: .5rem .7rem;
    }
    .emoji-picker__search:focus { outline: 2px solid #38BDF8; outline-offset: 2px; }
    .emoji-picker__close { border: none; background: transparent; font-size: 1.2rem; cursor: pointer; }
    .emoji-picker__grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(36px,1fr));
      gap: .4rem; padding: .6rem; max-height: 180px; overflow-y: auto;
    }
    .emoji-picker__item {
      font-size: 1.2rem; border-radius: 8px; padding: .2rem;
      text-align: center; cursor: pointer; border: none; background: transparent;
    }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 640px) {
      .communities-container { padding: 1rem; }
      .communities-grid { grid-template-columns: 1fr; }
    }
  </style>
{% endblock %}
{% block content %}
  {% include "includes/header.html" %}

  <main class="dashboard-layout">
    {% include "includes/sidebar.html" %}

    <main class="dashboard">
      <div class="communities-container">
        <!-- Header -->
        <div class="communities-header">
          <div class="communities-header-row">
            <div>
              <h2>Communities</h2>
              <p>Explore, create, and join communities with other students.</p>
            </div>
            <button id="open-create-modal" class="create-community-btn">+ Create community</button>
          </div>
        </div>

        <!-- Filters -->
        <div class="filter-bar">
          <input type="text" id="search-input" placeholder="Search communities..." aria-label="Search communities">
          <select id="sort-select" aria-label="Sort by">
            <option value="recent">Most recent</option>
            <option value="members">Most members</option>
            <option value="name">Name A-Z</option>
          </select>
        </div>

        <!-- Grid -->
        <div id="communities-grid" class="communities-grid"></div>

        <!-- Empty state -->
        <div id="community-list-empty" class="empty-state" style="display:none;">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"/>
          </svg>
          <p>No communities yet. Be the first to create one!</p>
        </div>
      </div>
    </main>
  </main>

  <!-- â”€â”€ Modal: Create community â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="create-community-modal" class="modal-backdrop" role="presentation">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="create-community-title">
      <div class="modal__header">
        <h3 id="create-community-title" class="modal__title">Create community</h3>
        <button class="modal__close" id="close-create-modal" aria-label="Close modal">&times;</button>
      </div>
      <div class="modal__body" role="document">
        <form id="create-community-form" class="community-form" novalidate>
          <div class="form__group">
            <label class="form__label" for="community-name">Title</label>
            <input type="text" id="community-name" class="form__field" placeholder="Community name" required>
          </div>
          <div class="form__group">
            <label class="form__label" for="community-tags">Keywords (comma-separated)</label>
            <input type="text" id="community-tags" class="form__field" placeholder="python, data, ml">
          </div>
          <div class="form__group">
            <label class="form__label" for="community-description">Description</label>
            <textarea id="community-description" class="form__field" rows="3" placeholder="What is this community about?"></textarea>
          </div>
          <div class="form__group">
            <label class="form__label" for="community-icon">Icon (optional emoji)</label>
            <div class="icon-input">
              <div class="icon-input__group">
                <span id="emoji-preview" class="icon-input__preview" aria-hidden="true">ðŸ‘¥</span>
                <input type="text" id="community-icon" class="icon-input__field" placeholder="Paste an emoji here" aria-label="Community emoji icon">
                <button type="button" class="icon-input__button" id="emoji-trigger" aria-haspopup="dialog" aria-expanded="false" aria-label="Open emoji picker">Choose</button>
              </div>
            </div>
            <div id="emoji-picker" class="emoji-picker" role="dialog" aria-label="Emoji picker" aria-hidden="true">
              <div class="emoji-picker__header">
                <input type="text" id="emoji-search" class="emoji-picker__search" placeholder="Search emoji..." aria-label="Search emoji">
                <button type="button" class="emoji-picker__close" id="emoji-close" aria-label="Close picker">&times;</button>
              </div>
              <div id="emoji-grid" class="emoji-picker__grid" role="listbox" aria-label="Emoji list"></div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal__footer">
        <button type="submit" form="create-community-form" class="primary-btn">Create</button>
      </div>
    </div>
  </div>

  {% include "includes/footer.html" %}

  <script>
    /* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    async function apiFetch(url, options = {}) {
      const res = await fetch(url, {
        credentials: 'include',
        headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
        ...options,
      });
      return res;
    }

    /* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    let allCommunities = [];

    /* â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const gridEl       = document.getElementById('communities-grid');
    const emptyEl      = document.getElementById('community-list-empty');
    const searchInput  = document.getElementById('search-input');
    const sortSelect   = document.getElementById('sort-select');

    /* Modal refs */
    const createModal       = document.getElementById('create-community-modal');
    const openModalBtn      = document.getElementById('open-create-modal');
    const closeModalBtn     = document.getElementById('close-create-modal');
    const createForm        = document.getElementById('create-community-form');
    const nameInput         = document.getElementById('community-name');
    const descInput         = document.getElementById('community-description');
    const tagsInput         = document.getElementById('community-tags');
    const iconInput         = document.getElementById('community-icon');
    const emojiPreview      = document.getElementById('emoji-preview');
    const emojiTrigger      = document.getElementById('emoji-trigger');
    const emojiPicker       = document.getElementById('emoji-picker');
    const emojiGrid         = document.getElementById('emoji-grid');
    const emojiSearch       = document.getElementById('emoji-search');
    const emojiClose        = document.getElementById('emoji-close');

    const emojiList = ['ðŸ˜€','ðŸ˜„','ðŸ˜Š','ðŸ˜','ðŸ¤©','ðŸ˜Ž','ðŸ¤“','ðŸ§ ','ðŸ“Š','ðŸ“ˆ','ðŸ’¡','ðŸš€','ðŸ','ðŸ—„ï¸','ðŸ“‰','ðŸ“š','ðŸŽ¯','ðŸ§©','ðŸ§ª','ðŸ’»','ðŸŒ','ðŸ¤–','ðŸŽ“','ðŸ“','ðŸ”¬'];

    /* â”€â”€ Load & render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function loadCommunities() {
      const res = await apiFetch('/api/v1/communities');
      if (!res.ok) { allCommunities = []; renderGrid(); return; }
      allCommunities = await res.json();
      renderGrid();
    }

    function getFiltered() {
      const q = searchInput.value.trim().toLowerCase();
      let list = allCommunities;
      if (q) {
        list = list.filter(c =>
          c.name.toLowerCase().includes(q) ||
          (c.description || '').toLowerCase().includes(q) ||
          (c.tags || []).some(t => t.toLowerCase().includes(q))
        );
      }
      const sort = sortSelect.value;
      if (sort === 'members') list.sort((a, b) => (b.member_count ?? 0) - (a.member_count ?? 0));
      else if (sort === 'name') list.sort((a, b) => a.name.localeCompare(b.name));
      else list.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      return list;
    }

    function renderGrid() {
      const list = getFiltered();
      gridEl.innerHTML = '';
      if (!list.length) { emptyEl.style.display = 'block'; return; }
      emptyEl.style.display = 'none';

      list.forEach(c => {
        const card = document.createElement('div');
        card.className = 'community-card';
        card.setAttribute('tabindex', '0');
        card.setAttribute('role', 'link');
        card.setAttribute('aria-label', `Go to ${escapeHtml(c.name)}`);

        const tagsHtml = (c.tags || []).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('');
        const members = c.member_count ?? 0;
        const status = c.activity_status || 'Active';

        card.innerHTML = `
          <div class="community-icon">${escapeHtml(c.icon || 'ðŸ‘¥')}</div>
          <h3 class="community-title">${escapeHtml(c.name)}</h3>
          <p class="community-description">${escapeHtml(c.description || 'No description.')}</p>
          <div class="community-stats">
            <div class="stat-item">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3.87-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              <span>${members} members</span>
            </div>
            <span class="community-status">${escapeHtml(status)}</span>
          </div>
          <div class="community-tags">${tagsHtml}</div>
          <button class="join-btn" data-id="${c.id}">View community</button>
        `;

        /* Click on card â†’ go to feed */
        const navigate = () => { window.location.href = '/community/' + c.id; };
        card.addEventListener('click', (e) => {
          if (e.target.closest('[data-id]')) return; /* button handles its own click */
          navigate();
        });
        card.addEventListener('keydown', (e) => { if (e.key === 'Enter') navigate(); });

        /* "View community" button */
        card.querySelector('[data-id]').addEventListener('click', (e) => {
          e.stopPropagation();
          navigate();
        });

        gridEl.appendChild(card);
      });
    }

    searchInput.addEventListener('input', renderGrid);
    sortSelect.addEventListener('change', renderGrid);

    /* â”€â”€ Modal: create community â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function openModal() {
      createModal.style.display = 'flex';
      document.body.classList.add('modal-open');
      nameInput.focus();
    }
    function closeModal() {
      createModal.style.display = 'none';
      document.body.classList.remove('modal-open');
      closeEmojiPicker();
    }

    openModalBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);
    createModal.addEventListener('click', (e) => { if (e.target === createModal) closeModal(); });

    createForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = nameInput.value.trim();
      if (!name) return;
      const description = descInput.value.trim();
      const tags = tagsInput.value.split(',').map(t => t.trim()).filter(Boolean);
      const icon = iconInput.value.trim();

      const res = await apiFetch('/api/v1/communities', {
        method: 'POST',
        body: JSON.stringify({
          name,
          description: description || null,
          tags: tags.length ? tags : null,
          icon: icon || null,
        }),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert(err.detail || 'Unable to create the community.');
        return;
      }
      const created = await res.json();
      nameInput.value = ''; descInput.value = ''; tagsInput.value = ''; iconInput.value = '';
      emojiPreview.textContent = 'ðŸ‘¥';
      closeModal();
      /* Go directly to the new community feed */
      window.location.href = '/community/' + created.id;
    });

    /* â”€â”€ Emoji picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderEmojis(filter = '') {
      emojiGrid.innerHTML = '';
      emojiList.filter(e => e.includes(filter)).forEach(emoji => {
        const btn = document.createElement('button');
        btn.type = 'button'; btn.className = 'emoji-picker__item';
        btn.textContent = emoji;
        btn.addEventListener('click', () => {
          emojiPreview.textContent = emoji; iconInput.value = emoji;
          closeEmojiPicker();
        });
        emojiGrid.appendChild(btn);
      });
    }
    function openEmojiPicker() {
      emojiPicker.style.display = 'block';
      emojiPicker.setAttribute('aria-hidden','false');
      emojiTrigger.setAttribute('aria-expanded','true');
      emojiSearch.focus();
    }
    function closeEmojiPicker() {
      emojiPicker.style.display = 'none';
      emojiPicker.setAttribute('aria-hidden','true');
      emojiTrigger.setAttribute('aria-expanded','false');
    }

    emojiTrigger.addEventListener('click', (e) => {
      e.preventDefault(); e.stopPropagation();
      emojiPicker.style.display === 'block' ? closeEmojiPicker() : openEmojiPicker();
    });
    emojiClose.addEventListener('click', closeEmojiPicker);
    emojiSearch.addEventListener('input', (e) => renderEmojis(e.target.value));

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (emojiPicker.style.display === 'block') { closeEmojiPicker(); return; }
        if (createModal.style.display === 'flex') closeModal();
      }
    });
    document.addEventListener('click', (e) => {
      if (emojiPicker.style.display === 'block' &&
          !emojiPicker.contains(e.target) && !emojiTrigger.contains(e.target))
        closeEmojiPicker();
    });

    /* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    renderEmojis();
    loadCommunities();
  </script>
{% endblock %}
